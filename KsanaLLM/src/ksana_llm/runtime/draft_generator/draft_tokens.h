/* Copyright 2025 Tencent Inc.  All rights reserved.

==============================================================================*/
#pragma once

#include <atomic>
#include <functional>
#include <vector>

namespace ksana_llm {

struct DraftTokens {
  // draft token generated by MTP, Trie and PTP
  std::vector<int> mtp;
  std::vector<int> trie;
  std::vector<int> ptp;

  std::vector<int> GetDraftTokens() const {
    std::vector<int> draft_tokens;
    draft_tokens.reserve(mtp.size() + trie.size() + ptp.size());
    draft_tokens.insert(draft_tokens.end(), mtp.begin(), mtp.end());
    draft_tokens.insert(draft_tokens.end(), trie.begin(), trie.end());
    draft_tokens.insert(draft_tokens.end(), ptp.begin(), ptp.end());
    return draft_tokens;
  }

  void TruncDraft(size_t new_size) {
    assert(new_size <= mtp.size() + trie.size() + ptp.size());
    if (mtp.size() > new_size) {
      mtp.resize(new_size);
      trie.clear();
      ptp.clear();
      return;
    }
    new_size -= mtp.size();
    if (trie.size() > new_size) {
      trie.resize(new_size);
      ptp.clear();
      return;
    }
    new_size -= trie.size();
    if (ptp.size() > new_size) {
      ptp.resize(new_size);
    }
  }

  void clear() {
    mtp.clear();
    trie.clear();
    ptp.clear();
  }

  size_t size() const { return mtp.size() + trie.size() + ptp.size(); }
};
}  // namespace ksana_llm
